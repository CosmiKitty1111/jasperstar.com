<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <!-- Redirect HTTP to HTTPS -->
        <rule name="HTTP to HTTPS redirect" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}{REQUEST_URI}" redirectType="Permanent" />
        </rule>

        <!-- Redirect index.html and index to directory (remove index from URL) -->
        <rule name="Remove index from URL" stopProcessing="true">
          <match url="^(.*/)?index(\.html)?$" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/404" negate="true" />
          </conditions>
          <action type="Redirect" url="{R:1}" redirectType="Permanent" appendQueryString="true" />
        </rule>

        <!-- Redirect .html extensions with trailing slash to clean URLs (301 permanent redirect) -->
        <rule name="Remove .html extension with trailing slash" stopProcessing="true">
          <match url="^(.*)\.html/$" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/404" negate="true" />
          </conditions>
          <action type="Redirect" url="{R:1}/" redirectType="Permanent" appendQueryString="true" />
        </rule>

        <!-- Redirect .html extensions to clean URLs (301 permanent redirect) -->
        <rule name="Remove .html extension" stopProcessing="true">
          <match url="^(.*)\.html$" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/404" negate="true" />
          </conditions>
          <action type="Redirect" url="{R:1}" redirectType="Permanent" appendQueryString="true" />
        </rule>

        <!-- Rewrite clean URLs to .html files internally -->
        <rule name="Add .html extension" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_FILENAME}.html" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="{R:1}.html" />
        </rule>

        <!-- Handle index.html for root and directories -->
        <rule name="Index.html rewrite" stopProcessing="true">
          <match url="^(.*/)?$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="{R:1}index.html" />
        </rule>

        <!-- Catch-all for 404s - rewrite to 404 page if no file/directory matches -->
        <rule name="404 Handler" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_FILENAME}.html" matchType="IsFile" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/404" negate="true" />
          </conditions>
          <action type="Rewrite" url="404.html" />
        </rule>
      </rules>
    </rewrite>

    <!-- Optional: Set default document -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.html" />
      </files>
    </defaultDocument>

    <!-- Custom 404 error handling - fallback if rewrite rules don't catch it -->
    <httpErrors errorMode="Custom" existingResponse="Replace">
      <remove statusCode="404" subStatusCode="-1" />
      <error statusCode="404" path="404.html" responseMode="File" />
    </httpErrors>

    <!-- Security headers to prevent mixed content warnings -->
    <httpProtocol>
      <customHeaders>
        <add name="Content-Security-Policy" value="upgrade-insecure-requests" />
        <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>

